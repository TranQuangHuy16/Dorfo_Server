# version: '3.9'

# services:
#   backend:
#     build: 
#       context: .
#       dockerfile: Dockerfile
#     ports:
#       - "5000:80"
#     depends_on:
#       - sqlserver
#       - redis
#     environment:
#       - ASPNETCORE_URLS=http://+:80
#       - ASPNETCORE_ENVIRONMENT=Development
#       # Connection strings
#       - ConnectionStrings__DorfoDb=${DB_CONNECTION}
#       - ConnectionStrings__Redis=${REDIS_CONNECTION}

#       # JWT
#       - Jwt__Key=${JWT_KEY}
#       - Jwt__Issuer=${JWT_ISSUER}
#       - Jwt__Audience=${JWT_AUDIENCE}

#       # SMTP
#       - Smtp__Host=${SMTP_HOST}
#       - Smtp__Port=${SMTP_PORT}
#       - Smtp__User=${SMTP_USER}
#       - Smtp__Pass=${SMTP_PASS}
#       - Smtp__EnableSsl=${SMTP_ENABLESSL}
#       - Smtp__DisplayName=${SMTP_DISPLAYNAME}

#       # PayOS
#       - PayOS__BaseUrl=${PAYOS_BASEURL}
#       - PayOS__ClientId=${PAYOS_CLIENTID}
#       - PayOS__ApiKey=${PAYOS_APIKEY}
#       - PayOS__ReturnUrl=${PAYOS_RETURNURL}
#       - PayOS__CallbackUrl=${PAYOS_CALLBACKURL}
#       - PayOS__ChecksumKey=${PAYOS_CHECKSUMKEY}

#       # Cloudinary
#       - Cloudinary__CloudName=${CLOUDINARY_CLOUDNAME}
#       - Cloudinary__ApiKey=${CLOUDINARY_APIKEY}
#       - Cloudinary__ApiSecret=${CLOUDINARY_APISECRET}
#     networks:
#       - dorfo-network

#   redis:
#     image: redis:7.4
#     container_name: redis
#     ports:
#       - "6379:6379"
#     networks:
#       - dorfo-network

#   sqlserver:
#     image: mcr.microsoft.com/mssql/server:2022-latest
#     container_name: sqlserver
#     ports:
#       - "1433:1433"
#     environment:
#       - ACCEPT_EULA=Y
#       - SA_PASSWORD=${SA_PASSWORD}
#     volumes:
#       - sqlserver-data:/var/opt/mssql  # ✅ Mount volume để dữ liệu không mất khi stop container
#     networks:
#       - dorfo-network

# volumes:
#   sqlserver-data:   # ✅ Định nghĩa volume

# networks:
#   dorfo-network:
#     driver: bridge


# version: '3.9'

# services:
#   backend:
#     build: 
#       context: .
#       dockerfile: Dockerfile
#     ports:
#       - "5000:80"
#     depends_on:
#       - postgres
#       - redis
#     environment:
#       - ASPNETCORE_URLS=http://+:80
#       - ASPNETCORE_ENVIRONMENT=Development
      
#       # Connection strings
#       - ConnectionStrings__DorfoDb=${DB_CONNECTION}   # ví dụ: Host=postgres;Port=5432;Database=dorfo;Username=postgres;Password=${POSTGRES_PASSWORD}
#       - ConnectionStrings__Redis=${REDIS_CONNECTION}

#       # JWT
#       - Jwt__Key=${JWT_KEY}
#       - Jwt__Issuer=${JWT_ISSUER}
#       - Jwt__Audience=${JWT_AUDIENCE}

#       # SMTP
#       - Smtp__Host=${SMTP_HOST}
#       - Smtp__Port=${SMTP_PORT}
#       - Smtp__User=${SMTP_USER}
#       - Smtp__Pass=${SMTP_PASS}
#       - Smtp__EnableSsl=${SMTP_ENABLESSL}
#       - Smtp__DisplayName=${SMTP_DISPLAYNAME}

#       # PayOS
#       - PayOS__BaseUrl=${PAYOS_BASEURL}
#       - PayOS__ClientId=${PAYOS_CLIENTID}
#       - PayOS__ApiKey=${PAYOS_APIKEY}
#       - PayOS__ReturnUrl=${PAYOS_RETURNURL}
#       - PayOS__CallbackUrl=${PAYOS_CALLBACKURL}
#       - PayOS__ChecksumKey=${PAYOS_CHECKSUMKEY}

#       # Cloudinary
#       - Cloudinary__CloudName=${CLOUDINARY_CLOUDNAME}
#       - Cloudinary__ApiKey=${CLOUDINARY_APIKEY}
#       - Cloudinary__ApiSecret=${CLOUDINARY_APISECRET}
#     networks:
#       - dorfo-network

#   redis:
#     image: redis:7.4
#     container_name: redis
#     ports:
#       - "6379:6379"
#     networks:
#       - dorfo-network

#   postgres:
#     image: postgres:16
#     container_name: postgres
#     ports:
#       - "5432:5432"
#     environment:
#       - POSTGRES_USER=${POSTGRES_USER}
#       - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
#       - POSTGRES_DB=${POSTGRES_DB}
#     volumes:
#       - postgres-data:/var/lib/postgresql/data  # ✅ Mount volume để giữ dữ liệu
#     networks:
#       - dorfo-network

# volumes:
#   postgres-data:   # ✅ Định nghĩa volume

# networks:
#   dorfo-network:
#     driver: bridge
version: '3.9'

services:
  backend:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: backend
    ports:
      - "5000:80"
    depends_on:
      - postgres
      - redis
    environment:
      - ASPNETCORE_URLS=http://+:80
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DorfoDb=${DB_CONNECTION}
      - ConnectionStrings__Redis=${REDIS_CONNECTION}
      - Jwt__Key=${JWT_KEY}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      - Smtp__Host=${SMTP_HOST}
      - Smtp__Port=${SMTP_PORT}
      - Smtp__User=${SMTP_USER}
      - Smtp__Pass=${SMTP_PASS}
      - Smtp__EnableSsl=${SMTP_ENABLESSL}
      - Smtp__DisplayName=${SMTP_DISPLAYNAME}
      - PayOS__BaseUrl=${PAYOS_BASEURL}
      - PayOS__ClientId=${PAYOS_CLIENTID}
      - PayOS__ApiKey=${PAYOS_APIKEY}
      - PayOS__ReturnUrl=${PAYOS_RETURNURL}
      - PayOS__CallbackUrl=${PAYOS_CALLBACKURL}
      - PayOS__ChecksumKey=${PAYOS_CHECKSUMKEY}
      - Cloudinary__CloudName=${CLOUDINARY_CLOUDNAME}
      - Cloudinary__ApiKey=${CLOUDINARY_APIKEY}
      - Cloudinary__ApiSecret=${CLOUDINARY_APISECRET}
      - Firebase__ProjectId=${FIREBASE_PROJECTID}

    networks:
      - dorfo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/swagger/index.html"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7.4
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - dorfo-network

  postgres:
    image: postgres:16
    container_name: postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - dorfo-network

  # nginx:
  #   image: nginx:latest
  #   container_name: nginx
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./certbot/www:/var/www/certbot   # folder cho webroot Certbot
  #     - ./certbot/conf:/etc/letsencrypt  # certificate
  #   depends_on:
  #     - backend
  #   networks:
  #     - dorfo-network
  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/www:/var/www/certbot
      - ./certbot/live:/etc/letsencrypt/live
      - ./certbot/archive:/etc/letsencrypt/archive
      - ./certbot/renewal:/etc/letsencrypt/renewal
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - dorfo-network
    restart: unless-stopped

  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/live:/etc/letsencrypt/live
      - ./certbot/archive:/etc/letsencrypt/archive
      - ./certbot/renewal:/etc/letsencrypt/renewal
    entrypoint: "/bin/sh -c 'while :; do sleep 12h & wait $${!}; certbot renew; done'"
    networks:
      - dorfo-network
    restart: unless-stopped
volumes:
  postgres-data:

networks:
  dorfo-network:
    driver: bridge
